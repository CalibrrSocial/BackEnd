# SSH into your server first, then run these commands:

# 1. Navigate to project
cd /var/www/api.calibrr.com/Social_Backend

# 2. Get latest code from main branch
git fetch origin
git reset --hard origin/main
git pull origin main

# 3. Install composer dependencies properly
composer install --no-dev --optimize-autoloader --ignore-platform-req=php

# 4. Clear everything
php artisan config:clear
php artisan cache:clear  
php artisan route:clear
php artisan view:clear
rm -f bootstrap/cache/*.php

# 5. Configure for file-based cache (avoid Redis issues)
cat > .env.override << 'EOF'
CACHE_DRIVER=file
SESSION_DRIVER=file
QUEUE_CONNECTION=sync
REDIS_HOST=127.0.0.1
EOF

# Merge with existing .env
if [ -f .env ]; then
    cp .env .env.backup
    cat .env.override >> .env
fi

# 6. Run migrations
php artisan migrate --force

# 7. Setup Passport OAuth
php artisan passport:keys --force
php artisan passport:client --personal --name="Personal Access Client" --no-interaction || true

# 8. Fix permissions
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 775 storage bootstrap/cache
sudo chmod -R 775 storage/logs

# 9. Rebuild caches
php artisan config:cache
php artisan route:cache

# 10. Create a test user (run in tinker)
php artisan tinker
>>> use App\Models\User;
>>> User::where('email', 'test@calibrr.com')->delete();
>>> User::create(['email' => 'test@calibrr.com', 'phone' => '5555551234', 'password' => bcrypt('Test123'), 'first_name' => 'Test', 'last_name' => 'User', 'dob' => '2000-01-01', 'email_verified_at' => now()]);
>>> exit

# 11. Restart services
sudo systemctl restart apache2
sudo systemctl restart php8.3-fpm

# 12. Test the API
curl -X POST https://api.calibrr.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@calibrr.com","password":"Test123"}'
